<!--@layout(/layout/basic/layout.html)-->
<!--@css(../css/module/product/module/detail.css)-->

<!--
    $category_page = /product/list.html
    $project_page = /product/project.html
    $jointbuy_page = /product/jointbuy.html
-->
<!--@import(./buy_screen.html)-->


<!-- ìƒí’ˆ ì •ë³´ ìƒë‹¨ -->
<article id="product_detail_top" module="product_detail">
    <!-- ìƒí’ˆ êµ¬ë§¤ íƒ­ -->
    <section id="buyAction" module="product_action">
        <button class="wish_btn" alt="ì°œ" onclick="{$action_wishlist}">ì°œ</button>
        <button class="gift_btn" onclick="toggleBuyScreen(`gift`);" alt="ì„ ë¬¼í•˜ê¸°">ì„ ë¬¼í•˜ê¸°</button>
        <button class="buy_btn" onclick="toggleBuyScreen(`cart`);" alt="êµ¬ë§¤í•˜ê¸°">êµ¬ë§¤í•˜ê¸°</button>
    </section>
    <!-- ìƒí’ˆ êµ¬ë§¤ íƒ­ -->

    <!-- ë¸Œëœë“œ -->
    <section class="product_brand">
        <h1 class="displaynone">ë¸Œëœë“œ ì†Œê°œ</h1>
        <h2>From. <em>{$prd_brand}</em></h2>
        <h3 class="summary_desc">{$summary_desc}</h3>
    </section>
    <!-- ë¸Œëœë“œ -->
    <!-- ì¸ë„¤ì¼ -->
    <section class="product_thumnail_wrap" module="product_image">
        <h1 class="displaynone">ì´ë¯¸ì§€</h1>
        <em class="product_icon">{$soldout_icon}{$recommend_icon} {$new_icon} {$product_icons} {$benefit_icons}</em>
        <img src="{$big_img}" alt="{$seo_alt_tag}" class="{$big_img_class}" />
    </section>
    <!-- ì¸ë„¤ì¼ -->
    <!-- ìƒí’ˆëª…, ê°€ê²©ì •ë³´, íƒœê·¸ -->
    <section class="product_info_wrap">
        <h1 class="displaynone">ìƒí’ˆ ì •ë³´</h1>
        <h2 class="product_name">{$name}</h2>
        <div class="price_wrap">
            <span class="sale_price price" data-price="{$product_sale_price}">{$product_sale_price|numberformat}<span>ì›</span>
            </span>
            <span class="product_price price" data-price="{$product_price}">{$product_price|numberformat}<span>ì›</span>
            </span>
        </div>
        <article id="tag-box" class="tag-box">
            <div>ğŸ¥¤ í”Œë¼ìŠ¤í‹± ì¤„ì´ê¸°</div>
        </article>
        <button id="shareBtn" class="share_btn">ê³µìœ í•˜ê¸°</button>
    </section>
    <!-- ìƒí’ˆëª…, ê°€ê²©ì •ë³´, íƒœê·¸ -->
    <!-- ìƒí’ˆ ë°°ì†¡ ì•ˆë‚´ -->
    <section class="delivery_wrap">
        <h1 class="displaynone">ë°°ì†¡ ì•ˆë‚´</h1>
        <ul class="delivery_info">
            <li>
                <span class="delivery_title">ë°°ì†¡ë¹„</span>
                <span class="delivery_detail">{$delivery_price|striptag}</span>
            </li>
            <li>
                <span class="delivery_title">ë°œì†¡ ì•ˆë‚´</span>
                <span class="delivery_detail"><em>ìµì¼ ì¶œê³ </em> (ì£¼ë§, ê³µíœ´ì¼ ì œì™¸)</span>
            </li>
        </ul>
    </section>
    <!-- ìƒí’ˆ ë°°ì†¡ ì•ˆë‚´ -->
    <!-- ë§ˆì¼ë¦¬ì§€ -->
    <section class="mileage_wrap">
        <h1>ë§ˆì¼ë¦¬ì§€</h1>
        <ul id="mileage">
            <li class="mileage_voter">
                <p>ë³´í„° ë“±ê¸‰</p>
                <p><em class="voter_value">{$mileage_value}</em><span>ì </span> ì ë¦½</p>
            </li>
            <li class="mileage_crew">
                <p>í¬ë£¨ ë“±ê¸‰</p>
                <p><em class="crew_value">{$mileage_value}</em><span>ì </span> ì ë¦½</p>
            </li>
            <li class="mileage_crew_txt mileage_txt"><a href="">ë¹„ë³´íŠ¸ í¬ë£¨</a>ëŠ” ë‘ ë°° ì ë¦½ë©ë‹ˆë‹¤.</li>
            <li class="mileage_mileage_txt mileage_txt">ë§ˆì¼ë¦¬ì§€ëŠ” ë¹„ë³´íŠ¸ ë‚´ì—ì„œ í˜„ê¸ˆì²˜ëŸ¼ ì‚¬ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
        </ul>
    </section>
    <!-- ë§ˆì¼ë¦¬ì§€ -->
    <section id="stamp_cont" class="stamp_wrap">
        <h1 class="stamp_title">ê°€ì¹˜ ìŠ¤íƒ¬í”„<span><em class="stamp_pcs"></em> ì§€ê¸‰</span></h1>
        <ul class="stamp_list">
            <li><span class="prd_stamp stamp0">1ê°œ</span></li>
            <li><span class="prd_stamp stamp1">2ê°œ</span></li>
            <li><span class="prd_stamp stamp2">3ê°œ</span></li>
            <li><span class="prd_stamp stamp3">4ê°œ</span></li>
            <li><span class="prd_stamp stamp4">5ê°œ</span></li>
        </ul>
        <p class="stamp_txt">ê°€ì¹˜ ìŠ¤íƒ¬í”„ 5ê°œë¥¼ ëª¨ìœ¼ë©´ <a href=""> í¬ë£¨ ë“±ê¸‰</a>ìœ¼ë¡œ ë“±ì—…ë©ë‹ˆë‹¤.</p>
    </section>
</article>
<!-- ìƒí’ˆ ì •ë³´ ìƒë‹¨ -->
<!-- ìƒí’ˆ ì •ë³´ í•˜ë‹¨ ì„ íƒ íƒ­ -->
<ul class="detail_tab_wrap" module="product_additional">
    <li class="tab1 tab" data-hash="prd_detail">ìƒí’ˆì •ë³´
    </li>
    <li class="tab2 tab" data-hash="prd_bh">ì†Œë¹„ê¸°ë¡
    </li>
    <li class="tab3 tab" data-hash="use_qna">Q&A({$qna_count})
    </li>
    <li class="tab4 tab" data-hash="prd_info">ë°°ì†¡ì•ˆë‚´
    </li>
</ul>
<!-- ìƒí’ˆ ì •ë³´ í•˜ë‹¨ ì„ íƒ íƒ­ -->
<!-- ìƒí’ˆ ì •ë³´ í•˜ë‹¨ -->
<article id="product_detail_bottom" module="product_additional">
    <!-- ìƒí’ˆ ì •ë³´ í•˜ë‹¨ ì •ë³´ -->
    <div id="detail_swiper_wrap" class="detail_swiper_wrap swiper-wrapper">
        <!-- tab0 ìƒí’ˆì •ë³´ -->
        <div id="tab0" class="tab_content swiper-slide" data-hash="prd_detail">
            <div id="prd_detail">
                <!--ì´ë²¤íŠ¸-->
                <div class="tab_detail_page eventArea {$common_event_a|display}">
                    <div class="event">{$common_event_a}</div>
                </div>
                <!--ìƒì„¸í˜ì´ì§€-->
                <div class="tab_detail_page">
                    <!--@css(../css/module/product/module/product_detail.css)-->
                    {$product_detail}
                </div>
            </div>
        </div>
        <!-- tab0 ìƒí’ˆì •ë³´ -->
        <!-- tab1 ì†Œë¹„ê¸°ë¡ -->
        <div id="tab1" class="tab_content swiper-slide" data-hash="prd_bh">
            <div id="prd_bh">
                <div id="buy_records_detail">
                    <iframe id="buy_record_frame" border="0"
                        src="https://bvoat-test.shop/buy_records?product_no={$product_no}"></iframe>
                </div>
            </div>
        </div>
        <!-- tab1 ì†Œë¹„ê¸°ë¡ -->
        <!-- tab2 Q&A -->
        <div id="tab2" class="tab_content swiper-slide" data-hash="use_qna">
            <div id="use_qna">
                <div class="tab-tip">
                    <div class="tab-tip-head tab3_heading">
                        <em>{$prd_model}</em>ì— ëŒ€í•´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?
                    </div>
                </div>
                <div class="product_detail_qna" module="product_qna">
                    <!--@css(/css/module/product/qna.css)-->
                    <!--@js(/js/module/product/qna.js)-->
                    <!--
                            $count = 6
                        -->
                    <p class="noAccess {$deny_display|display}">ê¸€ì½ê¸° ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    <ul class="tab-board-table {$list_display|display}">
                        <li class="descriptions">
                            <a class="description_link" title="{$subject}" href="/board/product/read.html{$param_read}">

                                <h1> {$icon_re} {$icon_lock} {$icon_mobile} {$subject} </h1>
                                <p>
                                    {$member_icon}
                                    <span class="id" title="ì‘ì„±ì">{$writer}</span>
                                    <span class="date {$date_display|display}" title="ì‘ì„±ì¼">{$write_date}</span>
                                </p>
                            </a>
                        </li>
                        <li class="descriptions">
                            <a class="description_link" title="{$subject}" href="/board/product/read.html{$param_read}">

                                <h1> {$icon_re} {$icon_lock} {$icon_mobile} {$subject} </h1>
                                <p>
                                    {$member_icon}
                                    <span class="id" title="ì‘ì„±ì">{$writer}</span>
                                    <span class="date {$date_display|display}" title="ì‘ì„±ì¼">{$write_date}</span>
                                </p>
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="tab-tips-btns">
                    <div class="qna_btn"><a href="{$qna_write}">ë¬¼ì–´ë³´ê¸°</a>
                    </div>
                </div>
                <div class="product_detail_paginate" module="product_qnapaging">
                    <div class="paginate-box">
                        <span class="btnPrev_wrap">
                            <a href="{$param_before}" class="btnPrev">ì´ì „</a>
                        </span>
                        <ol>
                            <li><a href="{$param}" class="{$param_class}">{$no}</a></li>
                            <li><a href="{$param}" class="{$param_class}">{$no}</a></li>
                            <li><a href="{$param}" class="{$param_class}">{$no}</a></li>
                            <li><a href="{$param}" class="{$param_class}">{$no}</a></li>
                            <li><a href="{$param}" class="{$param_class}">{$no}</a></li>
                        </ol>
                        <span class="btnNext_wrap">
                            <a href="{$param_next}" class="btnNext">ë‹¤ìŒ</a>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <!-- tab2 Q&A -->
        <!-- tab3 ë°°ì†¡ì•ˆë‚´ -->
        <div id="tab3" class="tab_content swiper-slide" data-hash="prd_info">
            <div id="prd_info">
                <div class="tab_prd_info">
                    <div class="title">ìƒí’ˆê²°ì œì •ë³´</div>
                    <div class="content">{$payment_info}</div>
                </div>
                <div class="tab_prd_info">
                    <div class="title">ë°°ì†¡ì •ë³´</div>
                    <div class="content">
                        <ul class="delivery">
                            <li>ë°°ì†¡ ë°©ë²• : {$shipping_method}</li>
                            <li>ë°°ì†¡ ì§€ì—­ : {$shipping_area}</li>
                            <li>ë°°ì†¡ ë¹„ìš© : {$shipping_fee}</li>
                            <li>ë°°ì†¡ ê¸°ê°„ : {$shipping_period}</li>
                            <li>ë°°ì†¡ ì•ˆë‚´ : {$shipping_info}</li>
                        </ul>
                    </div>
                </div>
                <div class="tab_prd_info">
                    <div class="title">êµí™˜/ë°˜í’ˆì •ë³´</div>
                    <div class="content">{$exchange_info}</div>
                </div>
                <div class="tab_prd_info">
                    <div class="title">ì„œë¹„ìŠ¤ ë¬¸ì˜</div>
                    <div class="content">{$supplier_id} & ë¹„ë³´íŠ¸ ì¹´ì¹´ì˜¤í†¡ ìƒë‹´</div>
                </div>
            </div>
        </div>
        <!-- tab4 ë°°ì†¡ì•ˆë‚´ -->
    </div>
    <!-- ìƒí’ˆ ì •ë³´ í•˜ë‹¨ ì •ë³´ -->
</article>
<!-- ìƒí’ˆ ì •ë³´ í•˜ë‹¨ -->

<!--@define(cmc_log)-->
<script>


    //ê°€ì¹˜ì†Œë¹„ê¸°ë¡ iframe ë†’ì´ ì¡°ì ˆ

    const computedHeight = (idx) => {
        const detailBottomWrap = document.getElementById("product_detail_bottom");
        const detailBottomContent = document.getElementById("detail_swiper_wrap");
        const tabContent = document.getElementById(`tab${idx}`);
        //í•¨ìˆ˜ ì‹¤í–‰
        if (document.readyState == 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                let firstTab = getComputedStyle(detailBottomContent);
            });
        } else {
            let tab = getComputedStyle(tabContent);
            const controlContentWrapHeight = () => {
                detailBottomWrap.style.height = tab.height;
                detailBottomContent.style.height = tab.height;
                tabContent.style.height = tab.height;
            }
            controlContentWrapHeight();
        }
    }
    //ìƒí’ˆ ìƒì„¸ í•˜ë‹¨ í˜ì´ì§€ íƒ­ ìŠ¬ë¼ì´ë”
    //node ê°’ ë°›ì•„ì„œ Array
    const tab = [...document.querySelectorAll(".tab")];
    const tab_txt = tab.map(node => node.innerHTML);
    const tab_hash = tab.map(node => node.dataset.hash);
    var swiper = new Swiper("#product_detail_bottom", {
        observer: true,
        observeParents: true,
        slidesPerView: 'auto',
        centeredSlides: true,
        spaceBetween: 22,
        loop: true,
        watchSlidesVisibility: true,
        watchSlidesProgress: true,
        edgeSwipeDetection: true,
        hashNavigation: {
            replaceState: true,
        },
        pagination: {
            el: ".detail_tab_wrap",
            clickable: true,
            renderBullet: function (index, className) {
                return `<span class="tab_custom swiper-pagination-bullet" tabindex="${index}" role="button" aria-label=${tab_txt[index]} data-hash=${tab_hash[index]}> ${tab_txt[index]} </span> `;
            },
        },
        on: {
            slideChangeTransitionEnd: function change() {
                computedHeight(swiper.realIndex);

            }

        },
    });


    //ìŠ¬ë¼ì´ë” ì´ì™¸ í•¨ìˆ˜ ì‹œì‘

    //Q&A heading ì»¨íŠ¸ë¡¤
    const qnaControl = () => {
        const dataCheck = document.querySelectorAll(".noAccess");
        const tabHeading = document.querySelectorAll(".tab3_heading");
        if (dataCheck.length != 0) {
            if (dataCheck[0].classList.value.includes("displaynone")) {
                tabHeading.forEach((node) => { node.classList.add("displaynone") })
            }
        }
    }

    //ì†Œë¹„ê¸°ë¡ ì»¨íŠ¸ë¡¤
    const buyRecordFrameControl = () => {    // ê°€ì¹˜ì†Œë¹„ê¸°ë¡ iframe ë†’ì´ ì¡°ì ˆ
        let bh_frame = document.querySelectorAll("#buy_record_frame");
        let bh_detail = document.querySelectorAll("#buy_records_detail");

        window.addEventListener("message", function (e) {
            let message = e.data;
            if (message && message.height) {
                bh_frame.forEach((node) => {
                    node.style.height = message.height + 10 + 'px';
                })
                bh_detail.forEach((node) => {
                    node.style.height = message.height + 10 + 'px';
                })
                //iframe ë†’ì´ ì¡°ì ˆ
            }
        });
        // ìŠ¤í¬ë¡¤ í•˜ë‹¨ê¹Œì§€ ê°”ì„ë•Œ iframe ì— ì „ë‹¬
        var loading = false;
        let sObj = {};
        let b_p = 0;
        let st = 0;
        // var iframe_content = document.getElementById('buy_record_frame').contentWindow;
        window.scroll(function () {
            // if ($("div.tab1 .swiper-slide-duplicate-active").length > 0) {
            st = window.scrollTop();
            if (b_p < st) {
                if (st + 200 >= document.height() - window.height()) {
                    //    if(!loading) 
                    {
                        sObj.more = true;
                        loading = true;
                        bh_frame.postMessage(sObj, '*');

                    }
                }
            }
            b_p = st;
            // }
        });
    }

    //í¬ë£¨ ë“±ê¸‰ ë§ˆì¼ë¦¬ì§€ 2ë°° ë³€í™˜
    const crewValueControl = (multiple) => {
        const voterValue = document.querySelector(".voter_value");
        const crewValue = document.querySelector(".crew_value");
        voterValue ? crewValue.innerHTML = (voterValue.innerHTML * multiple) : null;
    }

    //ê³µìœ  ì´ë²¤íŠ¸
    const goShrBtn = (type, _url) => {
        if (type == "link") {
            if (navigator.share) {
                navigator.share({
                    title: `[ë¹„ë³´íŠ¸]` + document.getElementsByClassName("product_name").innerText,
                    text: document.getElementsByClassName("product_name").innerText,
                    url: _url + '/?utm_source=webshareapi&utm_medium=link&utm_campaign=sharebylink&utm_content=funding_link',
                })
            }
        }
        else if (type == "kakao") {
            Kakao.Link.sendDefault({
                objectType: 'feed',
                content: {
                    title: document.getElementsByClassName("product_name").innerText,
                    description: document.getElementsByClassName("product_name").innerText,
                    imageUrl:
                        'https://bvoatofficial.cafe24.com/web/upload/share-image-1-7415ca0886cec14f1fbbe5c28cbccec1.png',
                    link: {
                        mobileWebUrl: _url + '/?utm_source=kakaotalk&utm_medium=sharelink&utm_campaign=sharebykakao',
                        webUrl: _url + '/?utm_source=kakaotalk&utm_medium=sharelink&utm_campaign=sharebykakao',
                    },
                },
                buttons: [
                    {
                        title: 'ë°”ë¡œê°€ê¸°',
                        link: {
                            mobileWebUrl: _url + '/?utm_source=kakaotalk&utm_medium=sharelink&utm_campaign=sharebykakao',
                            webUrl: _url + '/?utm_source=kakaotalk&utm_medium=sharelink&utm_campaign=sharebykakao',
                        },
                    },
                ],
            })
        }
    }
    const shareBtn = document.querySelector("#shareBtn");


    //ì„ ë¬¼í•˜ê¸° / êµ¬ë§¤í•˜ê¸° í´ë¦­
    const toggleBuyScreen = (type) => {
        console.log("type", type)
        const buyScreen = document.getElementById("buyScreen");
        const buyScreenBox = document.getElementById("buy_screen_box");

        buyScreen.classList.toggle("displaynone");
        buyScreenBox.classList.toggle("displaynone");
        buyScreenBox.classList.toggle("screen_on");
    }

    /* ê°€ê²© í• ì¸ê°€ í™•ì¸ í‘œì‹œ */
    const priceArr = document.querySelectorAll(".price");
    const salePrice = parseInt(document.querySelector(".sale_price").dataset.price);
    const productPrice = parseInt(document.querySelector(".product_price").dataset.price);
    //ê°€ê²© node í™•ì¸í•˜ê³  í•œ ê°œ ì—†ì• ê¸°
    //ê°€ê²© node í™•ì¸í•˜ê³  íŒë§¤ê°€ì— ìŠ¤íƒ€ì¼ ì ìš©
    const controlPriceStyle = (priceArr) => {
        salePrice === productPrice ?  priceArr[1].classList.add("displaynone") :          priceArr[1].classList.add("if_sale_price")
    };

    /* ê°€ê²© -> ìŠ¤íƒ¬í”„ */
    //ìŠ¤íƒ¬í”„ ê°¯ìˆ˜ ë³€ìˆ˜ í• ë‹¹
    const createStampPcsFromPrice = (price) => {
        return new Promise((resolve, reject)=>{
            let floatPrice;
            if(price < 0.5){
                floatPrice = 0;
            } else if( 0.5 < price && price < 1){
                floatPrice = 0.5;
            } else if (1 <= price && price < 5){
            let halfFloat = Math.floor(price) + 0.5;
            price < halfFloat ? floatPrice = halfFloat - 0.5 : floatPrice = halfFloat;
            } else if (5 < price){
                floatPrice = 5;
            }
            resolve(floatPrice);
        })
    }
    //ìŠ¤íƒ¬í”„ ê°¯ìˆ˜ DOM ì¶œë ¥
    const displayStampTxt = (productStamp) => {
            //ìŠ¤íƒ¬í”„ ìˆ«ì í‘œì‹œ
            const stampPcs = document.querySelector(".stamp_pcs");
            productStamp > 0 ? stampPcs.innerHTML=`${productStamp}ê°œ` : stampPcs.innerHTML="0ê°œ"
    }
    //ìŠ¤íƒ¬í”„ ì´ë¯¸ì§€ DOM ì¶œë ¥ 
    const displayStampImg = (productStamp) => {
            //ìŠ¤íƒ¬í”„ í‘œì‹œ
            let stampList = document.querySelectorAll(".prd_stamp");
            //ìŠ¤íƒ¬í”„ ì´ë¯¸ì§€ í‘œì‹œ
            let i = 0;
            if(Number.isInteger(productStamp)){
                while(i < productStamp){
                    stampList[i].classList.add("whole_stamp");
                    i++;
                }
            }else if(!Number.isInteger(productStamp)){
                while(i < productStamp){
                    stampList[i].classList.add("whole_stamp");
                    i++;
                }
                stampList[Math.floor(productStamp)].classList.add("half_stamp");
            }
    }
    //ìŠ¤íƒ¬í”„ promise ì§„í–‰
    const createStamp = (salePrice,createStampPcsFromPrice) => {
        //ìŠ¤íƒ¬í”„ ì´ ê°¯ìˆ˜ ë³€ìˆ˜ì— í• ë‹¹
         createStampPcsFromPrice(salePrice/10000)
         .then((res)=>{
            console.log("stamp", res, "ê°œ")
            displayStampImg(res);
            displayStampTxt(res);
        })
        .catch((reject)=>{
            console.log("ìŠ¤íƒ¬í”„ ì—ëŸ¬", reject);
            displayStampImg(0);
            displayStampTxt(0);
        })
    }

    /* ìµœì¢… í•¨ìˆ˜ ì‹¤í–‰ */
    //ì†Œë¹„ê¸°ë¡ ì»¨íŠ¸ë¡¤
    buyRecordFrameControl();
    //í¬ë£¨ ë“±ê¸‰ ë§ˆì¼ë¦¬ì§€ 2ë°° ë³€í™˜
    crewValueControl(2);
    //ê³µìœ  ì´ë²¤íŠ¸ í´ë¦­
    shareBtn.addEventListener("click", e => {
        const url = window.location.href;
        goShrBtn(`link`, url)
    })
    //Q&A heading ì»¨íŠ¸ë¡¤
    qnaControl();
    //ê°€ê²© ìŠ¤íƒ€ì¼ ì²˜ë¦¬
    controlPriceStyle(priceArr);
    //ìŠ¤íƒ¬í”„ ë§Œë“¤ê¸°
    createStamp(salePrice,createStampPcsFromPrice);
</script>